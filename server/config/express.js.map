{"version":3,"sources":["config/express.js"],"names":["app","env","get","use","express","static","path","join","config","root","set","engine","require","renderFile","bodyParser","urlencoded","extended","json","passport","initialize","session","secret","secrets","saveUninitialized","resave","cookie","secure","store","MongoStore","mongooseConnection","mongoose","connection","db","process","SAUCE_USERNAME","xframe","hsts","maxAge","includeSubDomains","preload","xssProtection","webpackDevMiddleware","stripAnsi","webpack","makeWebpackConfig","webpackConfig","DEV","compiler","browserSync","create","init","open","logFileChanges","proxy","port","ws","middleware","noInfo","stats","colors","timings","chunks","browserSyncPort","plugins","plugin","console","log","hasErrors","hasWarnings","sockets","emit","title","body","toString","timeout","reload"],"mappings":"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","file":"express.js","sourcesContent":["/**\n * Express configuration\n */\n\n'use strict';\n\nimport express from 'express';\nimport favicon from 'serve-favicon';\nimport morgan from 'morgan';\nimport bodyParser from 'body-parser';\nimport methodOverride from 'method-override';\nimport cookieParser from 'cookie-parser';\nimport errorHandler from 'errorhandler';\nimport path from 'path';\nimport lusca from 'lusca';\nimport config from './environment';\nimport passport from 'passport';\nimport session from 'express-session';\nimport connectMongo from 'connect-mongo/es5';\nimport mongoose from 'mongoose';\nvar MongoStore = connectMongo(session);\n\nexport default function(app) {\n  var env = app.get('env');\n\n  if(env === 'development' || env === 'test') {\n    app.use(express.static(path.join(config.root, '.tmp')));\n  }\n\n  if(env === 'production') {\n    app.use(favicon(path.join(config.root, 'client', 'favicon.ico')));\n  }\n\n  app.set('appPath', path.join(config.root, 'client'));\n  app.use(express.static(app.get('appPath')));\n  app.use(morgan('dev'));\n\n  app.set('views', `${config.root}/server/views`);\n  app.engine('html', require('ejs').renderFile);\n  app.set('view engine', 'html');\n  //app.use(shrinkRay());\n  app.use(bodyParser.urlencoded({ extended: false }));\n  app.use(bodyParser.json());\n  app.use(methodOverride());\n  app.use(cookieParser());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n\n  // Persist sessions with MongoStore / sequelizeStore\n  // We need to enable sessions for passport-twitter because it's an\n  // oauth 1.0 strategy, and Lusca depends on sessions\n  app.use(session({\n    secret: config.secrets.session,\n    saveUninitialized: true,\n    resave: false,\n    cookie: {secure: false},\n    store: new MongoStore({\n      mongooseConnection: mongoose.connection,\n      db: 'caportal'\n    })\n  }));\n\n  /**\n   * Lusca - express server security\n   * https://github.com/krakenjs/lusca\n   */\n  if(env !== 'test' && !process.env.SAUCE_USERNAME) {\n    app.use(lusca({\n      // csrf: {\n      //   angular: false\n      // },\n      xframe: 'SAMEORIGIN',\n      hsts: {\n        maxAge: 31536000, //1 year, in seconds\n        includeSubDomains: true,\n        preload: true\n      },\n      xssProtection: true\n    }));\n  }\n\n  if(env === 'development') {\n    const webpackDevMiddleware = require('webpack-dev-middleware');\n    const stripAnsi = require('strip-ansi');\n    const webpack = require('webpack');\n    const makeWebpackConfig = require('../../webpack.make');\n    const webpackConfig = makeWebpackConfig({ DEV: true });\n    const compiler = webpack(webpackConfig);\n    const browserSync = require('browser-sync').create();\n\n    /**\n     * Run Browsersync and use middleware for Hot Module Replacement\n     */\n    browserSync.init({\n      open: false,\n      logFileChanges: false,\n      proxy: `localhost:${config.port}`,\n      ws: true,\n      middleware: [\n        webpackDevMiddleware(compiler, {\n          noInfo: false,\n          stats: {\n            colors: true,\n            timings: true,\n            chunks: false\n          }\n        })\n      ],\n      port: config.browserSyncPort,\n      plugins: ['bs-fullscreen-message']\n    });\n\n    /**\n     * Reload all devices when bundle is complete\n     * or send a fullscreen error message to the browser instead\n     */\n    compiler.plugin('done', function(stats) {\n      console.log('webpack done hook');\n      if(stats.hasErrors() || stats.hasWarnings()) {\n        return browserSync.sockets.emit('fullscreen:message', {\n          title: 'Webpack Error:',\n          body: stripAnsi(stats.toString()),\n          timeout: 100000\n        });\n      }\n      browserSync.reload();\n    });\n  }\n\n  if(env === 'development' || env === 'test') {\n    app.use(errorHandler()); // Error handler - has to be last\n  }\n}\n"]}